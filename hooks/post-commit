#!/bin/bash
###
### The following block runs after commit to "master" branch
###
if [ `git rev-parse --abbrev-ref HEAD` == "master" ]; then

    # Layout prefix is prepended to each markdown file synced
    ###################################################################
    LAYOUT_PREFIX='---\r\nlayout: post-no-feature\r\n---\r\n\r\n'

    # Switch to gh-pages branch to sync it with master
    ###################################################################
    git checkout gh-pages

    # Sync the README.md in master to index.md adding jekyll header
    ###################################################################
    git checkout master -- README.md
    echo -e $LAYOUT_PREFIX > index.md
    cat README.md >> index.md
    rm README.md
    git add index.md
    git commit -a -m "Sync README.md in master branch to index.md in gh-pages"

    # Sync the markdown files in the docs/* directory
    ###################################################################
    git checkout master -- docs
    FILES=docs/*
    for file in $FILES
    do
        echo -e $LAYOUT_PREFIX | cat - "$file" > temp && mv temp "$file"
    done

    git add docs
    rm temp
    git commit -a -m "Sync docs from master branch to docs gh-pages directory"

    # Sync relational markdown files throughout directory branch and put
    # into _pages directory
    ####################################################################
    # first, check out the master
    git checkout master
    # then, get the path of the files ending in *.lyx
    rel_paths="$(find . -name \*.lyx -print | tr '\n' ' ' | sed 's:\.\/::g' )"
    # find the bibliography
    bibs="$(find . -name \*.bib -print | tr '\n' ' ' | sed 's:\.\/::g' )"
    # find the images
    images="$(find . -name \*.tex -print | tr '\n' ' ' | sed 's:\.\/::g' )"
    svgs="$(find . -name \*.svg -print | tr '\n' ' ' | sed 's:\.\/::g' )"
    # then, checkout the pdf branch
    git checkout pdf
    # then, checkout the files ending in *.lyx
    git checkout master -- $rel_paths
    # checkout the bibs
    git checkout master -- $bibs
    for file in $bibs
    do
        git add "$file"
    done
    #checkout the images
    git checkout master -- $images
    for file in $images
    do
        git add "$file"
    done
    # then, convert the files ending in *.lyx to *.tex
    for file in $rel_paths
    do
        lyx --export "latex" "$file"
        git add "`basename $file .lyx`.tex"
    done
    # then, commit the pdf generation files
    git commit -am 'made the pdf generation files required'
    # then, checkout the gh-pages branch
    git checkout gh-pages
    # then, checkout the files ending in *.lyx
    git checkout master -- $rel_paths
    # checkout all the bib files
    git checkout master -- $bibs
    for file in $bibs
    do
        git add "$file"
    done
    # checkout all the svgs
    git checkout master -- $svgs
    for file in $svgs
    do
        git add "$file"
    done
    # then, convert the files from *.lyx to *.md
    for file in $rel_paths
    do
        # define variables
        mdname = "`basename $file .lyx`.md"
        texname = "`basename $file .lyx`.tex"
        # export to tex
        lyx --export "latex" "$file"
        # export to md
        pandoc -o "$mdname" "$texname"
        # add yaml header
        echo -e $LAYOUT_PREFIX | cat - "$mdname" > temp && mv temp "_pages/$mdname"
        git add "_pages/$mdname"
    done
    # remove temp file if its there
    rm temp
    # then, commit the updated markdown files
    git commit -am 'added the updated markdown files'

    #git checkout master
    #rel_paths="$(find . -name \*.md -print | tr '\n' ' ' | sed 's:\.\/::g' )"
    #git checkout gh-pages
    #git checkout master -- $rel_paths
    #git checkout master -- hooks/rem.py
    #
    #mkdir _pages
    #for file in $rel_paths
    #do
    #    echo -e $LAYOUT_PREFIX | cat - "$file" > temp && mv temp "_pages/$file"
    #done

    #for file in $rel_paths
    #do
    #    python hooks/rem.py "$file" > temp
    #    mv temp "$file"
    #done

    #git add $rel_paths
    #rm temp
    #find . -name 'README.md' -exec sh -c 'git mv -f "$1" "$( echo $1 | sed 's/README/index/g' )"' _ {} \;
    #git commit -am 'updating all of the markdown documentation'

    
    # Uncomment the following push if you want to auto push to
    # the gh-pages branch whenever you commit to master locally.
    # This is a little extreme. Use with care!
    ###################################################################
    # git push origin gh-pages

    # Finally, switch back to the master branch and exit block
    git checkout master
fi

